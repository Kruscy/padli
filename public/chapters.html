<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>PadlizsanFanSub ‚Äì Manga</title>

  <!-- GLOBAL CSS -->
  <link rel="stylesheet" href="/css/header.css">
  <link rel="stylesheet" href="/css/sidebar.css">
  <link rel="stylesheet" href="/css/search.css">
  <link rel="stylesheet" href="/css/chapters.css">


  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">

</head>
<body>
<div id="header-root"></div>
<div id="sidebar-root"></div>


<!-- ===== CONTENT ===== -->
<main class="content">

  <div class="manga-header">
    <img id="coverImg" class="manga-cover" src="/assets/no-cover.png">

    <div class="manga-meta">
      <h1 id="mangaTitle">Loading‚Ä¶</h1>

      <div class="action-bar">
        <a id="continueBtn" class="btn primary hidden"> Folytat√°s</a>
        <button id="wantBtn" class="btn">Want to Read</button>
        <button id="favBtn" class="btn">‚ù§Ô∏è Kedvenc</button>
		<div id="editWrapper" class="edit-wrapper hidden">
			  <button id="editBtn" class="edit-btn" title="Szerkeszt√©s" type="button" >
  				  ‚úèÔ∏è
 			 </button>
		</div>

      </div>

      <p id="description" class="description"></p>
      <div id="tags" class="tags"></div>
    </div>
  </div>
  <h2 style="margin-top:40px">R√©szek</h2>
  <div id="chapters" class="chapter-list"></div>

  </div>
</div>

</main>

<script>
function parseChapterNumber(str) {
  // kiszedi az els≈ë sz√°mot (15, 15.5, 80.2 stb)
  const m = str.match(/\d+(\.\d+)?/);
  return m ? parseFloat(m[0]) : Infinity;
}

(async () => {
  const slug = new URLSearchParams(location.search).get("slug");
  if (!slug) return;

  let progress = null;

  /* ===== PROGRESS ===== */
  try {
    const r = await fetch(`/api/progress/${slug}`);
    if (r.ok) progress = await r.json();
  } catch {}

  /* ===== CHAPTERS ===== */
  try {
    const res = await fetch(`/api/chapters/${slug}`);
    let chapters = await res.json();

    /* ‚úÖ HELYES SORRENDEZ√âS (15 < 15.5 < 16) */
    chapters.sort((a, b) => {
      return parseChapterNumber(a.folder) - parseChapterNumber(b.folder);
    });

    const list = document.getElementById("chapters");
    list.innerHTML = "";

    chapters.forEach(ch => {
      const row = document.createElement("a");
      row.className = "chapter-row";
      row.href = `/reader.html?slug=${slug}&chapter=${encodeURIComponent(ch.folder)}`;

      /* üîπ olvasotts√°g */
      const read = progress && progress.chapter === ch.folder;

      const status = document.createElement("span");
      status.className = `read ${read ? "yes" : "no"}`;
      status.textContent = read ? "‚úÖ" : "‚¨ú";

      /* üîπ c√≠m */
      const title = document.createElement("span");
      title.className = "chapter-title";
      title.textContent = ch.folder;

      /* üîπ scan d√°tum */
      const date = document.createElement("span");
      date.className = "scan-date";
      if (ch.scanned_at) {
        const d = new Date(ch.scanned_at);
        date.textContent = d.toISOString().slice(0, 10);
      } else {
        date.textContent = "‚Äî";
      }

      row.append(status, title, date);
      list.appendChild(row);
    });

  } catch (e) {
    console.error("Chapter load error", e);
  }
})();
</script>

<script>
(async () => {
  const slug = new URLSearchParams(location.search).get("slug");
  if (!slug) return;

  /* ===== MANGA + METADATA ===== */
  const mRes = await fetch(`/api/manga/${slug}`);
  const manga = await mRes.json();

  document.getElementById("mangaTitle").textContent = manga.title;
  document.getElementById("coverImg").src =
    manga.cover_url || "/assets/no-cover.png";
  document.getElementById("description").innerHTML =
    manga.description || "";

  // tagek
  const tagsEl = document.getElementById("tags");
  tagsEl.innerHTML = "";
  manga.tags.forEach(t => {
    const s = document.createElement("span");
    s.textContent = t;
    tagsEl.appendChild(s);
  });
})();


</script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
  const wantBtn = document.getElementById("wantBtn");
  const continueBtn = document.getElementById("continueBtn");
  const slug = new URLSearchParams(location.search).get("slug");
  if (!wantBtn || !slug) return;

  /* ===== WANT STATE ===== */
  try {
    const r = await fetch(`/api/want/${slug}`);
    if (r.ok) {
      const d = await r.json();
      wantBtn.textContent = d.wanted
        ? "‚≠ê Want to Read"
        : "‚òÜ Want to Read";
    }
  } catch {}

  /* ===== TOGGLE ===== */
  wantBtn.addEventListener("click", async () => {
    const r = await fetch(`/api/want/${slug}`, { method: "POST" });
    if (!r.ok) return;

    const d = await r.json();
    wantBtn.textContent = d.wanted
      ? "‚≠ê Want to Read"
      : "‚òÜ Want to Read";
  });

  /* ===== CONTINUE ===== */
  try {
    const r = await fetch(`/api/progress/${slug}`);
    if (r.ok) {
      const p = await r.json();
      if (p) {
        continueBtn.classList.remove("hidden");
        continueBtn.href =
          `/reader.html?slug=${slug}&chapter=${p.chapter}&page=${p.page}`;
      }
    }
  } catch {}
});
</script>

<script>
(async () => {
  const slug = new URLSearchParams(location.search).get("slug");
  if (!slug) return;

  const res = await fetch(`/api/progress/${slug}`);
  if (!res.ok) return;

  const p = await res.json();
  if (!p) return;

  const btn = document.getElementById("continueBtn");
  btn.classList.remove("hidden");
  btn.href =
    `/reader.html?slug=${slug}&chapter=${p.chapter}&page=${p.page}`;
})();
</script>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const wrapper = document.getElementById("editWrapper");
  const btn = document.getElementById("editBtn");
  const menu = document.getElementById("editMenu");

  if (!wrapper || !btn || !menu) return;

  /* ===== ADMIN CHECK ===== */
  try {
    const res = await fetch("/api/auth/me");
    if (!res.ok) return;

    const user = await res.json();

    // üî¥ FONTOS: n√°lad role van, NEM is_admin
    if (user.role !== "admin") return;

    // ‚úÖ ADMIN ‚Üí ceruza megjelenik
    wrapper.classList.remove("hidden");
  } catch (err) {
    console.error("Admin check error", err);
    return;
  }

  /* ===== MENU TOGGLE ===== */
  btn.addEventListener("click", (e) => {
    e.stopPropagation();
    menu.classList.toggle("hidden");
  });

  /* ===== KATTINT√ÅS M√ÅSHOVA ‚Üí BEZ√ÅR ===== */
  document.addEventListener("click", () => {
    menu.classList.add("hidden");
  });

  /* ===== MEN√úN BEL√úLI KATT ‚Üí NEM Z√ÅR ===== */
  menu.addEventListener("click", (e) => {
    e.stopPropagation();
  });
});
</script>

<!-- ===== EDIT MODAL ===== -->
<div id="editModal" class="edit-modal hidden">
  <div class="edit-box">

    <h3>‚úèÔ∏è Manga szerkeszt√©se</h3>

    <label>
      Bor√≠t√≥k√©p URL
      <input id="editCoverInput" type="text" placeholder="https://..." />
    </label>

    <label>
      Le√≠r√°s
      <textarea id="editDescInput" rows="8"></textarea>
    </label>

    <div class="edit-actions">
      <button id="editCancel" class="btn">‚ùå M√©gse</button>
      <button id="editSave" class="btn primary">üíæ Ment√©s</button>
    </div>

  </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", async () => {
  const slug = new URLSearchParams(location.search).get("slug");
  if (!slug) return;

  /* ===== ADMIN CHECK ===== */
  const me = await fetch("/api/auth/me").then(r => r.ok ? r.json() : null);
  if (!me || me.role !== "admin") return;

  /* ===== ELEMEK ===== */
  const editWrapper = document.getElementById("editWrapper");
  const editBtn = document.getElementById("editBtn");
  const modal = document.getElementById("editModal");

  const coverInput = document.getElementById("editCoverInput");
  const descInput = document.getElementById("editDescInput");

  const saveBtn = document.getElementById("editSave");
  const cancelBtn = document.getElementById("editCancel");

  if (!editWrapper || !editBtn || !modal) return;

  /* ===== CERUZA MEGJELEN√çT ===== */
  editWrapper.classList.remove("hidden");

  /* ===== CERUZA ‚Üí MODAL ===== */
  editBtn.addEventListener("click", () => {
    coverInput.value = document.getElementById("coverImg")?.src || "";
    descInput.value = document.getElementById("description")?.innerText || "";
    modal.classList.remove("hidden");
  });

  /* ===== M√âGSE ===== */
  cancelBtn.addEventListener("click", () => {
    modal.classList.add("hidden");
  });

  /* ===== MENT√âS ===== */
saveBtn.addEventListener("click", async () => {
  const payload = {
    cover_url: coverInput.value || null,
    description: descInput.value || null
  };

  console.log("EDIT SLUG:", slug);
  console.log("EDIT PAYLOAD:", payload);

  try {
    const res = await fetch(`/api/admin/manga/${slug}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    console.log("EDIT RESPONSE STATUS:", res.status);

    const text = await res.text();
    console.log("EDIT RESPONSE BODY:", text);

    if (!res.ok) {
      alert("‚ùå Ment√©s sikertelen (backend error)");
      return;
    }

    document.getElementById("coverImg").src = payload.cover_url;
    document.getElementById("description").innerHTML = payload.description;

    modal.classList.add("hidden");
  } catch (err) {
    console.error("EDIT FETCH ERROR:", err);
  }
});

</script>


<script type="module" src="/js/layout-loader.js"></script>
<script src="/js/sidebar.js"></script>
<script src="/js/auth-check.js"></script>


</body>
</html>
