<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<title>PadlizsanFanSub – Reader</title>

<style>
body {
  margin: 0;
  background: #000;
  color: #fff;
  font-family: system-ui, sans-serif;
}

/* ===== TOP BAR ===== */
.topbar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 56px;
  background: rgba(0,0,0,.85);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  z-index: 100;
}

.topbar a,
.topbar button {
  background: #161b22;
  color: #fff;
  border: none;
  padding: 8px 14px;
  border-radius: 8px;
  cursor: pointer;
  text-decoration: none;
  font-weight: 600;
}

.topbar a:hover,
.topbar button:hover {
  background: #1f2630;
}

#chapterInfo {
  opacity: .85;
  font-size: 14px;
}

/* ===== PAGES ===== */
#pages {
  padding-top: 70px;
  padding-bottom: 70px;
  max-width: 900px;
  margin: 0 auto;
}

#pages img {
  width: 100%;
  display: block;
}

/* ===== BOTTOM BAR ===== */
.bottombar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 56px;
  background: rgba(0,0,0,.85);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  z-index: 100;
}

.bottombar button {
  background: #161b22;
  color: #fff;
  border: none;
  padding: 8px 14px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
}

.bottombar button:hover {
  background: #1f2630;
}
.manga-title {
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 16px;
}

</style>
</head>
<body>

<!-- ===== TOP BAR ===== -->
<div class="topbar">
  <a id="backBtn">⬅ Vissza</a>
<h1 id="mangaTitle" class="manga-title">Loading…</h1>

  <div id="chapterInfo" class="manga-title">Loading…</div>
</div>

<!-- ===== PAGES ===== -->
<div id="pages"></div>

<!-- ===== BOTTOM BAR ===== -->
<div class="bottombar">
  <button id="prevBtn">← Előző rész</button>
  <button id="nextBtn">Következő rész →</button>
</div>
<script>
(async () => {
  const slug = new URLSearchParams(location.search).get("slug");
  if (!slug) return;

  try {
    const mangas = await (await fetch("/api/manga")).json();
    const manga = mangas.find(m => m.slug === slug);
    if (!manga) return;

    document.getElementById("mangaTitle").textContent = manga.title;
    document.title = manga.title + " – Részek";
  } catch (e) {
    console.error("Cím betöltési hiba:", e);
  }
})();
</script>

<script>
/* ================= PARAMS ================= */
const params = new URLSearchParams(location.search);
const slug = params.get("slug");
const chapter = params.get("chapter");
const startPage = parseInt(params.get("page") || "1", 10);

const pagesEl = document.getElementById("pages");
const chapterInfo = document.getElementById("chapterInfo");

/* ================= HELPERS ================= */
function chapterKey(folder) {
  return folder.split(".").map(n => parseInt(n, 10));
}

function compareChapters(a, b) {
  const ak = chapterKey(a.folder);
  const bk = chapterKey(b.folder);
  for (let i = 0; i < Math.max(ak.length, bk.length); i++) {
    const av = ak[i] ?? 0;
    const bv = bk[i] ?? 0;
    if (av !== bv) return av - bv;
  }
  return 0;
}

/* ================= PROGRESS ================= */
let lastSavedPage = 0;
let saveTimeout = null;

function getCurrentPage() {
  const imgs = [...document.querySelectorAll("#pages img")];
  let current = 1;
  const mid = window.innerHeight / 2;

  imgs.forEach((img, i) => {
    if (img.getBoundingClientRect().top < mid) {
      current = i + 1;
    }
  });
  return current;
}

async function saveProgress(page) {
  if (!page || page === lastSavedPage) return;

  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(async () => {
    await fetch("/api/progress", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ slug, chapter, page })
    });
    lastSavedPage = page;
  }, 600);
}

window.addEventListener("scroll", () => {
  saveProgress(getCurrentPage());
});

/* ================= LOAD PAGES ================= */
async function loadPages() {
  const res = await fetch(`/api/pages/${slug}/${chapter}`);
  const files = await res.json();

  files.forEach((f, i) => {
    const img = document.createElement("img");
    img.src = `/api/image/${slug}/${chapter}/${encodeURIComponent(f)}`;
    img.loading = "lazy";
    pagesEl.appendChild(img);

    if (i + 1 === startPage) {
      setTimeout(() => img.scrollIntoView({ behavior: "auto" }), 100);
    }
  });
}

/* ================= NAV ================= */
async function loadNav() {
  const res = await fetch(`/api/chapters/${slug}`);
  const chapters = (await res.json()).sort(compareChapters);

  const index = chapters.findIndex(c => c.folder === chapter);
  chapterInfo.textContent = `Rész: ${chapter}`;

  document.getElementById("backBtn").href =
    `/chapters.html?slug=${slug}`;

  document.getElementById("prevBtn").onclick = () => {
    if (index > 0) {
      location.href =
        `/reader.html?slug=${slug}&chapter=${chapters[index - 1].folder}`;
    }
  };

  document.getElementById("nextBtn").onclick = () => {
    if (index < chapters.length - 1) {
      location.href =
        `/reader.html?slug=${slug}&chapter=${chapters[index + 1].folder}`;
    }
  };
}

/* ================= INIT ================= */
loadPages();
loadNav();
/* ================= UI TOGGLE ================= */
const topbar = document.querySelector(".topbar");
const bottombar = document.querySelector(".bottombar");

let uiVisible = true;

document.addEventListener("click", (e) => {
  // gombokra / linkekre ne reagáljon
  if (e.target.closest("button") || e.target.closest("a")) return;

  uiVisible = !uiVisible;

  topbar.style.opacity = uiVisible ? "1" : "0";
  bottombar.style.opacity = uiVisible ? "1" : "0";

  topbar.style.pointerEvents = uiVisible ? "auto" : "none";
  bottombar.style.pointerEvents = uiVisible ? "auto" : "none";
});

</script>

</body>
</html>
