<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<title>Minden Sorozat</title>
<link rel="stylesheet" href="/css/sidebar.css">
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/grid.css">
<link rel="stylesheet" href="/css/header.css">
<link rel="stylesheet" href="/css/profile.css">

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">

</head>
<body>
<div id="header-root"></div>
<div id="sidebar-root"></div>

<main class="content">
<div id="grid"></div>
</main>
<script>
(async function () {
  try {
    const res = await fetch("/api/manga");
    const mangas = await res.json();

    const grid = document.getElementById("grid");
    grid.innerHTML = "";

    // üîπ progress map (slug ‚Üí progress)
    const progressMap = {};

    // üîπ minden mang√°hoz megpr√≥b√°ljuk lek√©rni a progress-t
    await Promise.all(
      mangas.map(async (m) => {
        try {
          const r = await fetch(`/api/progress/${m.slug}`);
          if (r.ok) {
            const p = await r.json();
            if (p) progressMap[m.slug] = p;
          }
        } catch {
          // ha nincs progress ‚Üí semmi gond
        }
      })
    );

mangas.forEach(m => {
  const card = document.createElement("div");
  card.className = "card";

  /* ===== COVER (K√âP) ===== */
  const coverLink = document.createElement("a");
  coverLink.className = "cover";

  // default: chapters
  coverLink.href = `/chapters.html?slug=${encodeURIComponent(m.slug)}`;

  if (m.cover_url) {
    const img = document.createElement("img");
    img.src = m.cover_url;
    img.loading = "lazy";
    coverLink.appendChild(img);
  } else {
    coverLink.textContent = "No Cover";
  }

  // ‚ñ∂ FOLYTAT√ÅS ‚Äì csak ha van progress
  if (progressMap[m.slug]) {
    const badge = document.createElement("div");
    badge.className = "continue-badge";
    badge.textContent = "‚ñ∂ Folytat√°s";
    coverLink.appendChild(badge);

    coverLink.href =
      `/reader.html?slug=${encodeURIComponent(m.slug)}&chapter=${encodeURIComponent(progressMap[m.slug].chapter)}&page=${progressMap[m.slug].page}`;
  }

  /* ===== TITLE (C√çM) ===== */
  const titleLink = document.createElement("a");
  titleLink.className = "title";
  titleLink.href = `/chapters.html?slug=${encodeURIComponent(m.slug)}`;
  titleLink.textContent = m.title;

  card.appendChild(coverLink);
  card.appendChild(titleLink);
  grid.appendChild(card);
});

  } catch (e) {
    console.error("Failed to load manga", e);
  }
})();
</script>

<script type="module" src="/js/layout-loader.js"></script>
<script src="/js/sidebar.js"></script>
<script src="/js/auth-check.js"></script>

</body>
</html>
