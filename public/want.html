<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<title>Want To Read</title>
<link rel="stylesheet" href="/css/sidebar.css">
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/grid.css">
<link rel="stylesheet" href="/css/header.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">

</head>
<body>
<div id="header-root"></div>
<div id="sidebar-root"></div>

<main class="content">
  <h1>⭐ Want To Read</h1>
  <div id="grid"></div>
</main>

<script src="/js/auth-check.js"></script>

<script>
(async () => {
  const grid = document.getElementById("grid");
  if (!grid) return;

  /* ===== WANT TO READ LISTA ===== */
  let mangas = [];
  try {
    const res = await fetch("/api/want");
    if (!res.ok) return;
    mangas = await res.json();
  } catch (e) {
    console.error("Want list load error", e);
    return;
  }

  grid.innerHTML = "";

  /* ===== PROGRESS MAP ===== */
  const progressMap = {};

  await Promise.all(
    mangas.map(async (m) => {
      try {
        const r = await fetch(`/api/progress/${m.slug}`);
        if (!r.ok) return;
        const p = await r.json();
        if (p && p.chapter) {
          progressMap[m.slug] = p;
        }
      } catch {}
    })
  );

  /* ===== RENDER ===== */
  mangas.forEach(m => {
    const card = document.createElement("div");
    card.className = "card";

    /* --- COVER --- */
    const cover = document.createElement("div");
    cover.className = "cover";

    const img = document.createElement("img");
    img.src = m.cover_url || "/assets/no-cover.png";
    img.loading = "lazy";

    cover.appendChild(img);

    // kattintás a képre
    cover.addEventListener("click", () => {
      const p = progressMap[m.slug];
      if (p) {
        location.href =
          `/reader.html?slug=${encodeURIComponent(m.slug)}` +
          `&chapter=${encodeURIComponent(p.chapter)}` +
          `&page=${p.page}`;
      } else {
        location.href = `/chapters.html?slug=${encodeURIComponent(m.slug)}`;
      }
    });

    // badge, ha van progress
    if (progressMap[m.slug]) {
      const badge = document.createElement("div");
      badge.className = "continue-badge";
      badge.textContent = "▶ Folytatás";
      cover.appendChild(badge);
    }

    /* --- TITLE --- */
    const title = document.createElement("div");
    title.className = "title";
    title.textContent = m.title;

    title.addEventListener("click", () => {
      location.href = `/chapters.html?slug=${encodeURIComponent(m.slug)}`;
    });

    card.appendChild(cover);
    card.appendChild(title);
    grid.appendChild(card);
  });
})();
</script>

<script type="module" src="/js/layout-loader.js"></script>
<script src="/js/sidebar.js"></script>
<script src="/js/auth-check.js"></script>

</body>
</html>
