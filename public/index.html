<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<title>PadlizsanFanSub</title>
<link rel="stylesheet" href="/css/sidebar.css">
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/grid.css">
<link rel="stylesheet" href="/css/header.css">
<link rel="stylesheet" href="/css/profile.css">
<link rel="stylesheet" href="/css/main.css">


<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">

</head>
<body>
<div id="header-root"></div>
<div id="sidebar-root"></div>

<main class="content">
<h2>üìñ Most olvasott</h2>
<div id="grid" class="grid"></div>

<script>
(async function () {
  try {
    const mangas = await (await fetch("/api/manga")).json();
    const grid = document.getElementById("grid");
    grid.innerHTML = "";

    const items = await Promise.all(
      mangas.map(async (m) => {
        const [progressRes, chaptersRes] = await Promise.all([
          fetch(`/api/progress/${m.slug}`),
          fetch(`/api/chapters/${m.slug}`)
        ]);

        if (!progressRes.ok || !chaptersRes.ok) return null;

        const progress = await progressRes.json();
        if (!progress) return null;

        const chapters = await chaptersRes.json();
        if (!chapters.length) return null;

        const lastChapter = chapters[chapters.length - 1].folder;

        // ‚ùå ha el√©rte az utols√≥ r√©szt ‚Üí ne jelenjen meg
        if (progress.chapter === lastChapter) return null;

        return { manga: m, progress };
      })
    );

const filtered = items
  .filter(Boolean)
  .sort((a, b) => {
    // legut√≥bb olvasott el√∂l
    return new Date(b.progress.updated_at) - new Date(a.progress.updated_at);
  });

    if (!filtered.length) {
      grid.innerHTML = "<p>Nincs akt√≠v olvas√°sod.</p>";
      return;
    }

    filtered.forEach(({ manga, progress }) => {
      const card = document.createElement("div");
      card.className = "card";

      /* COVER ‚Üí FOLYTAT√ÅS */
      const coverLink = document.createElement("a");
      coverLink.className = "cover";
      coverLink.href =
        `/reader.html?slug=${encodeURIComponent(manga.slug)}&chapter=${encodeURIComponent(progress.chapter)}&page=${progress.page}`;

      if (manga.cover_url) {
        const img = document.createElement("img");
        img.src = manga.cover_url;
        img.loading = "lazy";
        coverLink.appendChild(img);
      }

      const badge = document.createElement("div");
      badge.className = "continue-badge";
      badge.textContent = "‚ñ∂ Folytat√°s";
      coverLink.appendChild(badge);

      /* TITLE ‚Üí CHAPTERS */
      const title = document.createElement("a");
      title.className = "title";
      title.href = `/chapters.html?slug=${encodeURIComponent(manga.slug)}`;
      title.textContent = manga.title;

      card.appendChild(coverLink);
      card.appendChild(title);
      grid.appendChild(card);
    });

  } catch (e) {
    console.error("Most olvasott hiba:", e);
  }
})();
</script>

<h2>üÜï √öj r√©szek</h2>
<div id="newGrid" class="content"></div>
<script>
(async function () {
  try {
    const res = await fetch("/api/manga");
    const mangas = await res.json();

    const grid = document.getElementById("newGrid");
    grid.innerHTML = "";

    const now = Date.now();
    const WEEK = 2 * 24 * 60 * 60 * 1000;

    const items = [];

    for (const m of mangas) {
      // chapters
      const chaptersRes = await fetch(`/api/chapters/${m.slug}`);
      if (!chaptersRes.ok) continue;

      const chapters = await chaptersRes.json();

      // csak 7 napon bel√ºl scannelt
      const recent = chapters.filter(ch => {
        if (!ch.scanned_at) return false;
        return now - new Date(ch.scanned_at).getTime() <= WEEK;
      });

      if (!recent.length) continue;

      // progress
      const progressRes = await fetch(`/api/progress/${m.slug}`);
      const progress = progressRes.ok ? await progressRes.json() : null;

      // ha az utols√≥ r√©sz m√°r ki van olvasva ‚Üí ne jelenjen meg
      if (progress) {
        const lastChapter = chapters[chapters.length - 1]?.folder;
        if (progress.chapter === lastChapter) continue;
      }

      // legfrissebb scan id≈ë
      const latestScan = recent
        .map(r => new Date(r.scanned_at))
        .sort((a, b) => b - a)[0];

      items.push({
        manga: m,
        recent,
        progress,
        latestScan
      });
    }

    // üîΩ RENDEZ√âS: legut√≥bb scannelt el√∂l
    items.sort((a, b) => b.latestScan - a.latestScan);

    // kirajzol√°s
    for (const item of items) {
      const { manga: m, recent, progress } = item;

      const card = document.createElement("div");
      card.className = "card";

      /* ===== COVER ===== */
      const coverLink = document.createElement("a");
      coverLink.className = "cover";

      coverLink.href = progress
        ? `/reader.html?slug=${encodeURIComponent(m.slug)}&chapter=${encodeURIComponent(progress.chapter)}&page=${progress.page}`
        : `/chapters.html?slug=${encodeURIComponent(m.slug)}`;

      if (m.cover_url) {
        const img = document.createElement("img");
        img.src = m.cover_url;
        img.loading = "lazy";
        coverLink.appendChild(img);
      }

      const badge = document.createElement("div");
      badge.className = "new-count";
      badge.textContent = `√öj r√©szek: +${recent.length}`;
      coverLink.appendChild(badge);

      /* ===== TITLE ===== */
      const title = document.createElement("a");
      title.className = "title";
      title.href = `/chapters.html?slug=${encodeURIComponent(m.slug)}`;
      title.textContent = m.title;

      card.appendChild(coverLink);
      card.appendChild(title);
      grid.appendChild(card);
    }

  } catch (e) {
    console.error("√öj r√©szek hiba:", e);
  }
})();
</script>

</main>


<script type="module" src="/js/layout-loader.js"></script>
<script src="/js/sidebar.js"></script>
<script src="/js/auth-check.js"></script>

</body>
</html>
